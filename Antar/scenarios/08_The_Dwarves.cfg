#textdomain wesnoth-Antar

#define INITIALIZE_SCENARIO_VARIABLES
	{VARIABLE generator_on           1}
	{VARIABLE undead_sighted         0}
	{VARIABLE wizard_status          0}
	{VARIABLE gomdring_found        no}
	{VARIABLE undead_meet            0}
	{VARIABLE count_Antars_men       0}
	{VARIABLE hidden_entrance_found no}
	{VARIABLE hint                  no}
	{VARIABLE hint_spoken           no}
	{VARIABLE moveto_count           0}
	{VARIABLE antar_in_the_mines    no}
#enddef
#define CLEAR_SCENARIO_VARIABLES
	{CLEAR_VARIABLE generator_on}                       ### generating undead
	{CLEAR_VARIABLE undead_sighted}
	{CLEAR_VARIABLE wizard_status}                      ### gomdrings talking at the end
	{CLEAR_VARIABLE turns_to_trigger}                   ### stop generating undead
	{CLEAR_VARIABLE random}                             ### generating undead random type
	{CLEAR_VARIABLE turns}                              ### add 10 turns after finding Gomdring
	{CLEAR_VARIABLE stored_dwarves}                     ### store dwarves to remove ai-special-guardian
	{CLEAR_VARIABLE stored_dwarves_for_recall}          ### store dwarves to remove ai-special-guardian
	{CLEAR_VARIABLE gomdring_found}                     ### check if Antar or soldier discovers Gomdring
	{CLEAR_VARIABLE undead_meet}                        ### to share enemys view
	{CLEAR_VARIABLE count_Antars_men}                   ### to count Antars men at start
	{CLEAR_VARIABLE hidden_entrance_found}              ### hint message makes only sense when entrance undiscovered
	{CLEAR_VARIABLE warden}                             ### messager when sombody stumbles upon noach
	{CLEAR_VARIABLE gomdrings_guard}                    ### throneroomguard
	{CLEAR_VARIABLE temp_x1}                            ### throneroomguard
	{CLEAR_VARIABLE temp_x2}                            ### throneroomguard
	{CLEAR_VARIABLE temp_y}                             ### throneroomguard
	{CLEAR_VARIABLE unit_found_cave}                    ### max movepoints for the unit whos fount the hidden entrance
	{CLEAR_VARIABLE turn_number}                        ### change turn number when gomdring is found
	{CLEAR_VARIABLE hint}                               ### for message when hidden entrance is found
	{CLEAR_VARIABLE hint_spoken}                        ### for don't capture allies villages message
	{CLEAR_VARIABLE moveto_count}                       ### to clear stay_inside_the_walls when Antar attacks
	{CLEAR_VARIABLE antar_in_the_mines}                 ### check if Antar is in the mine or not. needed for hint yes or no
	{CLEAR_VARIABLE clear_target_prisondoor}            ### to clear target prisondoor
	{CLEAR_VARIABLE stored_ugoshag}                     ### to check his hitpoints for victory conditons check
	{CLEAR_VARIABLE side_10_gold}                       ### fake gold side 10
	{CLEAR_VARIABLE Antars_men}                         ### stored Antars men from Dwarven Pass scenario
	{CLEAR_VARIABLE side_7_limited_recruits}            ### limit recruits macro
	{CLEAR_VARIABLE side_8_limited_recruits}            ### limit recruits macro
#enddef

### wizard_status 0 = wizard still in prison
### wizard_status 1 = wizzard free
### wizard_status 2 = wizzard dead

#define STAY_INSIDE_THE_WALLS
	[ai]
		turns=1-20
		[avoid]
			terrain=Hh,Hhd^Dr,Gs,Gd,Mm,Gg,Rb,Ds
		[/avoid]
		[and]
			[avoid]
				x=  31,32,33-35,60-70
				y=9-10,10,   11,30-33
			[/avoid]
		[/and]
	[/ai]
#enddef

#define DWARV_BEHAVIOR
	[ai]
		aggression=0.75
		caution=0.25
		village_value=1.0
		passive_leader=no
		grouping=yes
		recruitment_ignore_bad_combat=no
		{ASoR_AI_GOAL__PROTECT_LOCATION__X_Y_RADIUS_VALUE 47 16 6 5}
		{ASoR_AI_GOAL__PROTECT_UNIT__ID_RADIUS_VALUE "Gomdring" 8 20}
	[/ai]
#enddef

#define OBJECTIVES_NEW NEWOBJ
	[objectives]
		side=1
		[objective]
			description=_ "{NEWOBJ}"
			condition=win
		[/objective]
		[objective]
			description=_ "Death of Antar"
			condition=lose
		[/objective]
		[objective]
			description=_ "Death of Dagor"
			condition=lose
		[/objective]
		[objective]
			description=_ "Death of Gelphrad"
			condition=lose
		[/objective]
		[objective]
			description=_ "Death of Gomdring (The Leader of the Dwarves)"
			condition=lose
		[/objective]
		[objective]
			description=_ "Turns run out"
			condition=lose
		[/objective]

		note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
	[/objectives]
#enddef

#define VIPDEAD
	[remove_shroud]
		x,y=$x1,$y1
		radius=2
		side=1
	[/remove_shroud]
	[message]
		speaker=unit
		message= _ "Arrgghh."
	[/message]
#enddef

#define MAKE_CANRECRUIT_NO ID
	[if]
		[have_unit]
			id={ID}
		[/have_unit]
		[then]
			[modify_unit]
				[filter]
					id={ID}
				[/filter]
				canrecruit=no
			[/modify_unit]
			[store_unit]
				[filter]
					id={ID}
				[/filter]
				kill=yes
				variable={ID}_store
			[/store_unit]
			[unit]
				id={ID}
				name= _ "{ID}"
				type=${ID}_store.type
				side=${ID}_store.side
				x,y=${ID}_store.x,${ID}_store.y
				experience=${ID}_store.experience
				moves=${ID}_store.moves
				random_traits=no
			[/unit]
			[clear_variable]
				name={ID}_store
			[/clear_variable]
		[/then]
	[/if]
#enddef

#define IF_HAVE_UNIT_GOTO_XY UNIT GOTO_X GOTO_Y
	[if]
		[have_unit]
			id={UNIT}
		[/have_unit]
		[then]
			[modify_unit]
				[filter]
					id={UNIT}
				[/filter]
				goto_x={GOTO_X}
				goto_y={GOTO_Y}
			[/modify_unit]
		[/then]
	[/if]
#enddef











[scenario]
	id="The_Dwarves"
	name= _ "The Dwarves"
	map_data="{~add-ons/Antar/maps/08_The_Dwarves.map}"

	{TURNS 28 26 24}

	victory_when_enemies_defeated="no"

	{DEFAULT_SCHEDULE}

	[time_area]
		x=1-70,7-70,17-70,27-70,37-70,43-70,45-70
		y=1-2,3-6,7-9,10-14,15-20,21-28,29-44
		{UNDERGROUND}
	[/time_area]
 
	next_scenario="Flight_Tunnel"

	{MOOD_EPIC}

	[side]
		{ANTAR_SIDE}
		recruit= Sergeant, Spearman, Bowman, Horseman, Heavy Infantryman, Cavalryman
		team_name=Antar
		gold=100
		fog=no
		shroud=yes
		{FLAG_VARIANT loyalist}
	[/side]

	{STARTING_VILLAGES 1 6}

	[side]
		type=Dwarvish Berserker
		id="Aigatsil"
		name= _ "Aigatsil"
		side=2
		color=ASoR__Steelblue
		facing=sw
		canrecruit=yes
		{STAY_INSIDE_THE_WALLS}
		{DWARV_BEHAVIOR}
		recruit= Dwarvish Ulfserker, Dwarvish Fighter
		team_name=Antar,Gomdring
		user_team_name= _ "Dwarves (Ally)"
		gold=80
		income=0   #3
		{FLAG_VARIANT knalgan}
	[/side]

	{STARTING_VILLAGES 2 7}

	[side]
		type=Dwarvish Steelclad
		id="Nardris"
		name= _ "Nardris"
		side=3
		color=ASoR__Cornflowerblue
		facing=se
		canrecruit=yes
		{STAY_INSIDE_THE_WALLS}
		{DWARV_BEHAVIOR}
		recruit= Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Ulfserker,Dwarvish Scout
		team_name=Antar,Gomdring
		user_team_name= _ "Dwarves (Ally)"
		gold=80
		income=0   #5
		{FLAG_VARIANT knalgan}
	[/side]

	{STARTING_VILLAGES 3 7}


	[side]
		{GOMDRING_SIDE}
		side=4
		recruit= Dwarvish Fighter, Dwarvish Thunderer, Dwarvish Guardsman, Dwarvish Scout, Dwarvish Ulfserker
		team_name=Antar,Gomdring
		{STAY_INSIDE_THE_WALLS}
		{DWARV_BEHAVIOR}
		[ai]
			passive_leader=yes
			passive_leader_shares_keep=no
			{ASoR_AI_GOAL__TARGET_SIDE__SIDES_VALUE     10 6}
			{ASoR_AI_GOAL__TARGET_SIDE__SIDES_VALUE  (7,8) 1}
		[/ai]
		gold=10
		income=0
		{FLAG_VARIANT knalgan}
	[/side]

	{STARTING_VILLAGES 4 16}


	[side]
		type=Dwarvish Steelclad
		id="Ambergur"
		name= _ "Ambergur"
		side=5
		color=ASoR__Dodgerblue
		facing=sw
		canrecruit=yes
		{STAY_INSIDE_THE_WALLS}
		{DWARV_BEHAVIOR}
		recruit= Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Ulfserker,Dwarvish Scout
		team_name=Antar,Gomdring
		user_team_name= _ "Dwarves (Ally)"
		[ai]
			{ASoR_AI_GOAL__TARGET_SIDE__SIDES_VALUE     10 3}
			{ASoR_AI_GOAL__TARGET_SIDE__SIDES_VALUE  (7,8) 1}
		[/ai]
		gold=80
		income=0   #5
		{FLAG_VARIANT knalgan}
	[/side]

	{STARTING_VILLAGES 5 13}


	[side]
		type=Dwarvish Steelclad
		id="Noringgurt"
		name= _ "Noringgurt"
		side=6
		color=ASoR__Lightskyblue   # Navyblue
		facing=sw
		canrecruit=yes
		{STAY_INSIDE_THE_WALLS}
		{DWARV_BEHAVIOR}
		recruit= Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Ulfserker,Dwarvish Scout
		team_name=Antar,Gomdring
		user_team_name= _ "Dwarves (Ally)"
		gold=80
		income=0   #3
		{FLAG_VARIANT knalgan}
	[/side]

	{STARTING_VILLAGES 6 8}



	[side]
		type=Death Knight
		id="Lord Menachem"
		name= _ "Lord Menachem"
		profile=portraits/undead/draug.png~FL()~RIGHT()
		side=7
		color=ASoR__Orchid
		canrecruit=yes
		recruit= Walking Corpse, Soulless, Skeleton, Skeleton Archer, Revenant, Deathblade
		recruitment_pattern=fighter,fighter,archer
		recruitment_ignore_bad_combat=yes
		team_name=Mal Kazur
		user_team_name= _ "Undead (Enemy)"
		facing=nw
		controller=ai
		[ai]
			turns=1-17
			[avoid]
				x=1-9
				y=1-33
			[/avoid]
		[/ai]
		[ai]
			time_of_day=dawn,morning,afternoon
			caution=0.5
			aggression=0.5
			passive_leader=no
		[/ai]
		[ai]
			time_of_day=dusk,first_watch,second_watch
			caution=0.0
			aggression=1.0
			passive_leader=no
		[/ai]
		[ai]
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Ambergur) 4}
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Nardris)  1}
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Antar)    1}
		[/ai]
		{FLAG_VARIANT ragged}
		{GOLD 170 190 210}
		{INCOME 17 19 22}
	[/side]

	{STARTING_VILLAGES 7 9}

	[side]
		type=Death Knight
		id="Lord Baruch"
		name= _ "Lord Baruch"
#		profile=portraits/undead/draug.png~RIGHT()
		side=8
		color=ASoR__Purple4
		canrecruit=yes
		recruit= Walking Corpse, Soulless, Skeleton, Skeleton Archer, Revenant, Deathblade
		recruitment_pattern=fighter,archer
		recruitment_ignore_bad_combat=yes
		team_name=Mal Kazur
		user_team_name= _ "Undead (Enemy)"
		facing=nw
		controller=ai
		[ai]
			turns=1-17
			[avoid]
				x=1-11
				y=1-33
			[/avoid]
		[/ai]
		[ai]
			time_of_day=dawn,morning,afternoon
			caution=0.5
			aggression=0.5
			passive_leader=no
		[/ai]
		[ai]
			time_of_day=dusk,first_watch,second_watch
			caution=0.0
			aggression=1.0
			passive_leader=no
		[/ai]
		[ai]
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Gomdring) 4}
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Nardris)  1}
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Antar)    1}
		[/ai]
		{FLAG_VARIANT ragged}
		{GOLD 170 190 210}
		{INCOME 17 19 22}
	[/side]

	{STARTING_VILLAGES 8 8}

	[side]
		side=9
		color=ASoR__Mediumorchid
		controller=ai
		no_leader=yes
		recruit= Walking Corpse, Soulless
		team_name=Mal Kazur,Prisondoor
		user_team_name= _ "Prisoner (Enemy)"
		facing=se
		controller=null
		[ai]
			caution=0.0
			aggression=1.0
		[/ai]
		[ai]
			{ASoR_AI_GOAL__TARGET_SIDE__ID_VALUE (Gomdring) 10}
		[/ai]
		income=-2
		{FLAG_VARIANT ragged}
		{GOLD 100 120 150}
	[/side]

	[side]
		side=10
		color=purple
		controller=ai
		no_leader=yes
		user_team_name= _ "Undead (Enemy)"
		team_name=Mal Kazur
		[ai]
			aggression=1.0
			caution=0.0
			village_value=0.0
		[/ai]
		{FLAG_VARIANT ragged}
		{GOLD 1512 1404 1296}
	[/side]

	[side]
		side=11
		color=black
		controller=null
		no_leader=yes
		team_name=Antar,Gomdring,Prisondoor
		user_team_name= _ "Prisondoor"
		hidden=yes
	[/side]


#	{ASoR_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT (7,8)                  "Revenant" 2 2 2}                      ### replaced by recruit_per_turn macro
#	{ASoR_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT (7,8)                "Deathblade" 2 3 3}                      ### replaced by recruit_per_turn macro
	{ASoR_LIMIT_RECRUITS_DIFFICULTY_DEPENDANT (7,8)                              "Bone Shooter" 2 2 3}
	{ASoR_LIMIT_RECRUITS_DIFFICULTY_DEPENDANT (7,8)                                   "Banebow" 0 1 2}
	{ASoR_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT (9)                      "Wraith" 1 2 2}
	{ASoR_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT (9)                  "Nightgaunt" 1 2 2}
	{ASoR_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT (9)                      "Shadow" 1 2 2}
	{ASoR_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT (9)                     "Spectre" 1 2 2}

	{STORY_THE_DWARVES}





	[event]
		name=prestart

		[remove_shroud]
			side=1
			x,y=4,33
			radius=7
		[/remove_shroud]

		[unit]
			type=Prisondoor
			id=Prisondoor1
			name= _ "Prisondoor"
			side=11
			x,y=47,15
		[/unit]

		[unit]
			type=Prisondoor
			id=Prisondoor2
			name= _ "Prisondoor"
			side=11
			x,y=48,13
		[/unit]

		[unit]
			type=Necromancer
			id=Noach
			name= _ "Noach"
			side=9
			canrecruit=yes
			x=46
			y=12
			facing=se
		[/unit]

		[unit]
			type=Revenant Mage
			id="Ugoshag"
			name= _ "Ugoshag"
			profile=portraits/Ugoshag.png
			side=10
			canrecruit=yes
			x=66
			y=32
			facing=sw
			moves=0
		[/unit]

		{ASoR_GENERIC_NAMED_LOYAL_GUARD_UNIT 4 "Dwarvish Sentinel" 57  3 (Balmor)  }       #######the throne room guards
		{ASoR_GENERIC_NAMED_LOYAL_GUARD_UNIT 4 "Dwarvish Stalwart" 59  3 (Angudus) }       #######the throne room guards
		{ASoR_GENERIC_NAMED_LOYAL_GUARD_UNIT 4 "Dwarvish Stalwart" 60  8 (Borudus) }       #######this throne room guard stops Antar
		{ASoR_GENERIC_NAMED_LOYAL_GUARD_UNIT 4 "Dwarvish Sentinel" 56  8 (Alantor) }       #######this throne room guard stops Antar

		{ASoR_GENERIC_NAMED_GUARD_UNIT 4 "Dwarvish Fighter"        48 16 (Aifried) }       #######the prison guards
		{ASoR_GENERIC_NAMED_GUARD_UNIT 4 "Dwarvish Fighter"        53 18 (Andobrur)}       #######the prison guards
		{ASoR_GENERIC_NAMED_GUARD_UNIT 4 "Dwarvish Stalwart"       47 19 (Beomir)  }       #######the prison guards
		{ASoR_GENERIC_NAMED_GUARD_UNIT 4 "Dwarvish Stalwart"       49 20 (Ferodur) }       #######the prison guards
		{ASoR_GENERIC_NAMED_GUARD_UNIT 4 "Dwarvish Stalwart"       53 25 (Narfus)  }       #######the prison guards
		{ASoR_GENERIC_NAMED_GUARD_UNIT 4 "Dwarvish Sentinel"       47 16 (Brumdrus)}       #######the prison guards

		{GENERIC_UNIT 7 "Skeleton Archer"       17 13}                                     #######the starting attackers
		{GENERIC_UNIT 7 "Skeleton Archer"       16 12}                                     #######the starting attackers
		{GENERIC_UNIT 7 "Skeleton"              19 13}                                     #######the starting attackers
		{GENERIC_UNIT 7 "Revenant"              18 18} {GUARDIAN}                          #######the starting attackers
		{GENERIC_UNIT 7 "Skeleton"              19 23} {GUARDIAN}                          #######the starting attackers

		{GENERIC_UNIT 8 "Skeleton"              35 28}                                     #######the starting attackers
		{GENERIC_UNIT 8 "Revenant"              37 30}                                     #######the starting attackers
		{GENERIC_UNIT 8 "Revenant"              37 33}                                     #######the starting attackers



		{ASoR_SCENERY ground-skeleton.png        48 11}
		{ASoR_SCENERY coal.png                   31  9}
		{ASoR_SCENERY coal.png                   41  2}
		{ASoR_SCENERY coal.png                   45  2}
		{PLACE_IMAGE items/bones.png             54 14}
		{PLACE_IMAGE scenery/gate-rusty-se.png   48 13}
		{PLACE_IMAGE scenery/gate-rusty-sw.png   47 15}

		[remove_shroud]
			x,y=6,27
			radius=4
			side=1
		[/remove_shroud]
		[remove_shroud]
			x,y=3,33
			radius=5
			side=1
		[/remove_shroud]

		[capture_village]
			x,y=28,20
			side=8
		[/capture_village]

		{FOREACH Antars_men i}
			{VARIABLE Antars_men[$i].moves $Antars_men[$i].max_moves}
			{VARIABLE Antars_men[$i].hitpoints $Antars_men[$i].max_hitpoints}
			{VARIABLE Antars_men[$i].status.poisoned no}
			{VARIABLE Antars_men[$i].status.slowed no}
			{VARIABLE Antars_men[$i].attacks_left $Antars_men[$i].max_attacks}
			[unstore_unit]
				variable=Antars_men[$i]
				x,y=3,25
				find_vacant=yes
				fire_event=yes
			[/unstore_unit]
			[modify_unit]
				[filter]
					variable=Antars_men[$i]
				[/filter]
				facing=ne
			[/modify_unit]
			{VARIABLE_OP count_Antars_men add 1}
		{NEXT i}
		{CLEAR_VARIABLE Antars_men}


		{OBJECTIVES_NEW (Find The Dwarves)}

		{ASoR_HOLY_AMULET 1    34 18}

		{CLEAVE_EVENTS}
		{HIT_AND_RUN_EVENTS}

		{GET LOOSERS_GOLD 7}
		{GET LOOSERS_GOLD 8}


		{ASoR__KILL_REMAINING_UNDEAD_AND_RISE_AGAIN  7}
		{ASoR__KILL_REMAINING_UNDEAD_AND_RISE_AGAIN  8}

		{ASoR__RECRUIT_PER_TURN 7 (Deathblade)       1}
		{ASoR__RECRUIT_PER_TURN 7 (Revenant)         1}
		{ASoR__RECRUIT_PER_TURN 7 (Skeleton Archer)  3}
		{ASoR__RECRUIT_PER_TURN 7 (Skeleton)         2}

		{ASoR__RECRUIT_PER_TURN 2 (Dwarvish Fighter) 1}

		{ASoR__RECRUIT_PER_TURN 8 (Deathblade)       2}
		{ASoR__RECRUIT_PER_TURN 8 (Revenant)         1}
		{ASoR__RECRUIT_PER_TURN 8 (Skeleton Archer)  1}
		{ASoR__RECRUIT_PER_TURN 8 (Skeleton)         2}

		### side 4-6 should retreat when injured
		{FORCE_TO_HEAL_WOUNDED_UNITS 4 10}
		{FORCE_TO_HEAL_WOUNDED_UNITS 5 10}
		{FORCE_TO_HEAL_WOUNDED_UNITS 6 10}

		{INITIALIZE_SCENARIO_VARIABLES}
	[/event]

	[event]
		name=side 4 turn
		first_time_only=no
		[if]
			[variable]
				name=undead_meet
				numerical_equals=1
			[/variable]
			[then]
				[remove_shroud]
					side=1
					[filter]
						side=7
					[/filter]
					radius=1
				[/remove_shroud]
				[remove_shroud]
					side=1
					[filter]
						side=8
					[/filter]
					radius=1
				[/remove_shroud]
			[/then]
		[/if]
	[/event]


		######################################################################
		### create some random undead each turn until Antar meets Gomdring ###
		######################################################################

	[event]
		name=new turn
		first_time_only=no
		[if]
			[variable]
				name=generator_on
				numerical_equals=1
			[/variable]
			[then]
				[if]
					[variable]
						name=wizard_status
						numerical_equals=0
					[/variable]
					[then]
						{RANDOM (Bone Shooter,Revenant,Deathblade,Deathblade)}
						[unit]
							type=$random
							side=10
							x=66
							y=33
							goto_x=48
							goto_y=11
						[/unit]
						{CLEAR_VARIABLE random}
					[/then]
					[else]
						{RANDOM (Bone Shooter,Revenant,Deathblade,Deathblade)}
						[unit]
							type=$random
							side=10
							x=66
							y=33
						[/unit]
						{CLEAR_VARIABLE random}
					[/else]
				[/if]

				{RANDOM (Skeleton,Skeleton Archer,Bone Shooter,Revenant,Skeleton,Skeleton Archer,Deathblade,Soulless,Death Squire)}
				[unit]
					type=$random
					side=10
					x=68
					y=33
				[/unit]
				{CLEAR_VARIABLE random}

				{RANDOM (0,0,0,1,1)}
				[if]
					[variable]
						name=random
						equals=1
					[/variable]
					[then]
						[unit]
							type="Walking Corpse"
							variation=dwarf
							side=10
							x=67
							y=33
						[/unit]
					[/then]
				[/if]
				{CLEAR_VARIABLE random}

				[store_gold]
					side=10
					variable=side_10_gold
				[/store_gold]
				{VARIABLE_OP side_10_gold sub 18}
			[/then]
		[/if]
	[/event]

	# keeps Ugoshag from moving
	[event]
		name=turn refresh
		first_time_only=no
#		[if]
#			[variable]
#				name=generator_on
#				numerical_equals=1
#			[/variable]
#			[then]
				[modify_unit]
					[filter]
						id="Ugoshag"
					[/filter]
					moves=0
				[/modify_unit]
#			[/then]
#		[/if]
	[/event]

	### force side 2 to recruit some Ulfserkers first
	[event]
		name=turn 3
		[allow_recruit]
			side=2
			type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Scout
		[/allow_recruit]
	[/event]


		############################################
		#### message when Antar meets the undead ###
		############################################

	{ON_SIGHTING (undead) 1 (side=7,8,9) (
		[message]
			speaker=unit
			message= _ "Undead."
		[/message]
		{CUE_BATTLE}
		[remove_shroud]
			x,y=$x2,$y2
			radius=2
			side=1
		[/remove_shroud]
		[message]
			speaker=second_unit
			message= _ "The Dwarves are getting assistance."
		[/message]
		[remove_shroud]
			x,y=17,23
			radius=7
			side=1
		[/remove_shroud]
		[remove_shroud]
			x,y=12,30
			radius=7
			side=1
		[/remove_shroud]
		[message]
			speaker="Lord Menachem"
			message= _ "No matter.
Just kill them and bring me their heads!"
		[/message]
		[delay]
			time=200
		[/delay]
		[remove_shroud]
			x,y=21,31
			radius=7
			side=1
		[/remove_shroud]
		[message]
			speaker="Lord Baruch"
			message= _ "They will die, just like those ugly tiny little Dwarves, ha ha ha."
		[/message]
	)}


		#########################################################################
		#### give a hint about the hidden entrance when Antars forces to week ###
		#########################################################################

		#### set a variable when Antar steps on cave floor

	[event]
		name=moveto
		[filter]
			id="Antar"
			[filter_location]
				terrain=U*
			[/filter_location]
		[/filter]
		{VARIABLE_OP antar_in_the_mines value yes}
	[/event]

#	[event]
#		name=moveto
#		[filter]
#			id="Antar"
#			[filter_location]
#				terrain=Cud
#			[/filter_location]
#		[/filter]
#		{VARIABLE_OP antar_in_the_mines value yes}
#	[/event]


	[event]
		name=moveto
		[filter]
			id="Antar"
			[filter_location]
				terrain=Kud, Cud
			[/filter_location]
		[/filter]
		{VARIABLE_OP antar_in_the_mines value yes}
	[/event]

	[event]
		name=attack end
		first_time_only=no
		[filter]
			side=7
		[/filter]
		[filter_second]
			side=1
		[/filter_second]
		[if]
			[variable]
				name=count_Antars_men
				less_than=14
			[/variable]
			[variable]
				name=hidden_entrance_found
				equals=no
			[/variable]
			[variable]
				name=turn_number
				greater_than=5
			[/variable]
			[variable]
				name=hint
				equals=no
			[/variable]
			[variable]
				name=antar_in_the_mines
				equals=no
			[/variable]
			[then]
				[if]
					[have_unit]
						id=Garulf
					[/have_unit]
					[then]
						[message]
							speaker="Garulf"
							message= _ "The Undead forces seem to be superior. To the north-east is a hidden entrance to the mines."
						[/message]
						[message]
							speaker="Garulf"
							message= _ "*to Lord Antar*   My Lord, you should try to find the entrance while we try to fight the enemy here."
						[/message]
					[/then]
					[else]
						[role]
							role=dwarf_survivor_or_dagor
							id=Grimbold,Toughkon,Dunamus,Dunamil,Dorobald,Dagor
						[/role]
						[message]
							role=dwarf_survivor_or_dagor
							message= _ "The Undead forces seem to be superior. To the north-east is a hidden entrance to the mines."
						[/message]
						[message]
							role=dwarf_survivor_or_dagor
							message= _ "*to Lord Antar*   My Lord, you should try to find the entrance while we try to fight the enemy here."
						[/message]
					[/else]
				[/if]
				{VARIABLE_OP hint value yes}
			[/then]
		[/if]
		{CLEAR_VARIABLE count_Antars_men}
	[/event]


		###############################################
		#### end stay inside the wall for this side ###
		###############################################

	[event]
		name=moveto
		first_time_only=no
		[filter]
			side=1
			[filter_location]
				x,y=20,18
				radius=5
			[/filter_location]
		[/filter]
		{VARIABLE_OP moveto_count add 1}
		[if]
			[variable]
				name=moveto_count
				numerical_equals=4
			[/variable]
			[then]
				[modify_side]
					side=2
					[ai]
						[avoid]
							terrain=Ds
						[/avoid]
					[/ai]
				[/modify_side]
#				[if]
#					[have_unit]
#						side=2
#						canrecruit=yes
#					[/have_unit]
#					[then]
#						[modify_side]
#							side=5
#							[ai]
#								[avoid]
#									terrain=Ds
#								[/avoid]
#							[/ai]
#						[/modify_side]
#					[/then]
#				[/if]
#				[if]
#					[variable]
#						name=hint
#						equals=no
#					[/variable]
#					[variable]
#						name=hidden_entrance_found
#						equals=no
#					[/variable]
#					[variable]
#						name=antar_in_the_mines
#						equals=no
#					[/variable]
#					[then]
#						[message]
#							speaker="Aigatsil"
#							message= _ "The Undead forces seem to be superior. To the north-east is a hidden entrance to the mines."
#						[/message]
#					[/then]
#				[/if]
			[/then]
		[/if]
	[/event]

	[event]
		name=moveto
		[filter]
#			id="Aigatsil"
			side=2
			[filter_location]
				terrain=G*
			[/filter_location]
		[/filter]
		[if]
			[have_unit]
				side=2
				count=5-999
			[/have_unit]
			[then]
				[message]
					speaker="Aigatsil"
					message= _ "Lets make a sally! Crush these boneheads to the ground."
				[/message]
			[/then]
		[/if]
	[/event]


		#####################################
		### don't capture allies villages ###
		#####################################

	[event]
		name=capture
		first_time_only=no
		[filter]
			side=1
		[/filter]
		[if]
			[variable]
				name=hint_spoken
				equals=no
			[/variable]
			[then]
				[if]
					[variable]
						name=owner_side
						greater_than=1
					[/variable]
					[variable]
						name=owner_side
						less_than=7
					[/variable]
					[then]
						[if]
							[variable]
								name=unit.id
								equals=Dagor
							[/variable]
							[then]
								[message]
									speaker="Antar"
									message=_ "Don't capture the dwarvish villages. That's not a good idea if we want to ask the Dwarves for their help."
								[/message]
							[/then]
							[else]
								[message]
									speaker="Dagor"
									message=_ "Don't capture the dwarvish villages. That's not a good idea if we want to ask the Dwarves for their help."
								[/message]
							[/else]
						[/if]
						{VARIABLE_OP hint_spoken value yes}
					[/then]
					[else]
						### what if?
					[/else]
				[/if]
			[/then]
		[/if]
	[/event]


		################################################################
		#### message and new objectives when Antar meets the dwarves ###
		################################################################

	{ON_SIGHTING (dwarves) 1 side=2,3,4,5,6 (
		[remove_shroud]
			x,y=$x2,$y2
			radius=2
			side=1
		[/remove_shroud]
		[scroll_to]
			x=$x2
			y=$y2
		[/scroll_to]
		[if]
			[variable]
				name=unit.race
				equals=dwarf
			[/variable]
			[then]
				[message]
					speaker=unit
					message= _ "Hey $second_unit.name!"
				[/message]
				[message]
					speaker=second_unit
					message= _ "$unit.name you are allied with the Humans?"
				[/message]
				[message]
					speaker=unit
					message= _ "They are friends. They want to meet our leader."
				[/message]
			[/then]
			[else]
				[message]
					speaker=second_unit
					message= _ "Hey, there are Humans!"
				[/message]
				[message]
					speaker=unit
					message= _ "We found them!"
				[/message]
				[message]
					speaker=second_unit
					message= _ "If you want to fight with us, you are welcome!"
				[/message]
				[message]
					speaker=unit
					message= _ "We’re here to speak with your leader."
				[/message]
			[/else]
		[/if]
		[message]
			speaker=second_unit
			message= _ "Our leader Gomdring is busy!  He crushes bones inside our mines. The Undead attacked us, they come from all sides. You will have to fight your way to meet him."
		[/message]
		[remove_shroud]
			terrain=Gg,Gd,Gg^Es,Gll^Fp,Aa,Hhd^Vhhr
			[not]
				x=1-10
			[/not]
			radius=1
			side=1
		[/remove_shroud]
		[remove_shroud]
			x,y=38,28
			radius=7
			side=1
		[/remove_shroud]
		[remove_shroud]
			x,y=30,22
			radius=5
			side=1
		[/remove_shroud]

		{OBJECTIVES_NEW (Find Gomdring, and move Antar to meet him)}

		{VARIABLE_OP undead_meet add 1}
	)}


		#######################################################
		#### when some unit discoveres the main evil leader ###
		#######################################################

	{ON_SIGHTING (undead_main_leader) (1) (id="Ugoshag") (
		[message]
			speaker=unit
			message= _ "This one seems to be their leader."
		[/message]
		{ASoR_REMOVE_SHROUD_SCROLLTO 66 32 3 1}
		[if]
			[have_unit]
				side=10
				count=8-999
			[/have_unit]
			[then]
				[message]
					speaker="Ugoshag"
					message= _ "I am your destiny, prepare to die."
				[/message]
			[/then]
			[else]
				[message]
					speaker="Ugoshag"
					message= _ "This isn't going like the master has planned."
				[/message]
			[/else]
		[/if]
	)}


		#############################
		### Ugoshag gets attacked ###
		#############################

	[event]
		name=attack_end
		first_time_only=no
		[filter_second]
			id=Ugoshag
		[/filter_second]
		[store_unit]
			[filter]
				id=Ugoshag
			[/filter]
			variable=stored_ugoshag
			kill=no
		[/store_unit]
		[unstore_unit]
			variable=stored_ugoshag
			fire_event=yes
		[/unstore_unit]
		[if]
			[variable]
				name=stored_ugoshag.hitpoints
				greater_than=30
			[/variable]
			[then]
				[message]
					speaker=Ugoshag
					message= _ "By the masters might, die!"
				[/message]
			[/then]
			[else]
				[message]
					speaker=Ugoshag
					message= _ "Uh, I better retreat!"
				[/message]
				{MOVE_UNIT id=Ugoshag 70 33}
				[kill]
					id=Ugoshag
					animate=no
				[/kill]
				[kill]
					side=10
					animate=yes
				[/kill]
				[endlevel]
					result=victory
				[/endlevel]
			[/else]
		[/if]
		{CLEAR_VARIABLE stored_ugoshag}
	[/event]


		########################################################
		#### when the good guys discover the hidden entrance ###
		########################################################

	[event]
		name=moveto
		[filter]
			side=1
			[filter_location]
				x,y=4,6
				radius=4
			[/filter_location]
		[/filter]
		[remove_shroud]
			x,y=4,6
			radius=4
			side=1
		[/remove_shroud]
		{ASoR_SCROLL_TO 4 4 300}
		[if]
			[variable]
				name=hint
				equals=no
			[/variable]
			[then]
				[message]
					speaker=unit
					message= _ "Huh, what is that? Looks like a hole in the rocks."
				[/message]
				[message]
					speaker=unit
					message= _ "Seems I found a secret entrance."
				[/message]
			[/then]
			[else]
				[message]
					speaker=unit
					message= _ "There, a hole in the rocks."
				[/message]
				[message]
					speaker=unit
					message= _ "Seems I found the secret entrance to the mines."
				[/message]
			[/else]
		[/if]
		{VARIABLE_OP hidden_entrance_found value yes}
		{VARIABLE_OP hint                  value yes}
	[/event]


		########################################
		#### some good fighters for Gomdring ###
		########################################

		### better create some units, than this silly allow recruit way

	[event]
		name=turn 4
		[allow_recruit]
			type=Dwarvish Dragonguard,Dwarvish Runesmith,Dwarvish Stalwart
			side=4
		[/allow_recruit]
	[/event]  

	[event]
		name=turn 9
		[disallow_recruit]
			type=Dwarvish Dragonguard,Dwarvish Runesmith,Dwarvish Stalwart
			side=4
		[/disallow_recruit]
	[/event]


		####################################################
		#### when the good guys discover the prisoncells ###
		####################################################

	[event]
		name=moveto
		[filter]
			side=1
			[filter_location]
				x,y=47,15
				radius=3
			[/filter_location]
		[/filter]
		[if]
			[have_unit]
				id="Prisondoor2"
			[/have_unit]
			[then]
				[remove_shroud]
					x,y=47,15
					radius=4
					side=1
				[/remove_shroud]
				[message]
					speaker=unit
					message= _ "Uh, a prisoner?"
				[/message]
				[store_unit]
						[filter]
							side=2,3,4,5,6
							[filter_location]
								x,y=47,15
								radius=4
							[/filter_location]
						[/filter]
						variable=warden
						kill=no
				[/store_unit]
				[unstore_unit]
					variable=warden
					fire_event=yes
				[/unstore_unit]
				[message]
					speaker=$warden.id
					message= _ "Yes, a mighty dark sorcerer. The Undead want to free him."
				[/message]
				[message]
					speaker="Noach"
					message= _ "Soon I will be free again, to take revenge!"
				[/message]
				[message]
					speaker=$warden.id
					message= _ "*angry* Be quiet or you feel the cold steel of my axe!"
				[/message]
				{CLEAR_VARIABLE warden}
			[/then]
		[/if]
	[/event]


		########################################################
		#### give gold to attackers when they about to loose ###
		########################################################

	[event]
		name=attack
		first_time_only=yes
		[filter]
			id="Lord Menachem"
		[/filter]
		[gold]
			side=7
			amount=80
		[/gold]
	[/event]

	[event]
		name=attack
		first_time_only=yes
		[filter]
			id="Lord Baruch"
		[/filter]
		[gold]
			side=8
			amount=80
		[/gold]
	[/event]


		############################################################
		#### give gold to attackers when they reach the 1st goal ###
		############################################################

	[event]
		name=moveto
		first_time_only=yes
		[filter]
			id="Lord Menachem"
			x,y=20,8
		[/filter]
		[gold]
			side=7
			amount=20
		[/gold]
	[/event]

	[event]
		name=moveto
		first_time_only=yes
		[filter]
			id="Lord Baruch"
			x,y=44,29
		[/filter]
		[gold]
			side=8
			amount=20
		[/gold]
	[/event]


		##################################
		#### when Antar meets Ambergur ###
		##################################

	[event]
		name=moveto
		[filter]
			id=Antar
			[filter_location]
				x,y=40,6
				radius=6
			[/filter_location]
		[/filter]
		[message]
			speaker="Antar"
			message= _ "Are you Gomdring?"
		[/message]
		{ASoR_REMOVE_SHROUD_SCROLLTO 40 5 2 1}
		{ASoR_DELAY 150}
		[message]
			speaker="Ambergur"
			message= _ "No, I am Ambergur!  You are looking for Gomdring? You will find him east of here in the throne-room."
		[/message]
	[/event]


		###################################
		#### when Side 1 meets Gomdring ###
		###################################

	[event]
		name=moveto
		[filter]
			side=1
			[not]
				id="Antar"
			[/not]
			[filter_location]
				x,y=58,9
				radius=3
			[/filter_location]
		[/filter]
		[if]
			[variable]
				name=gomdring_found
				equals=no
			[/variable]
			[then]
				[remove_shroud]
					x,y=58,5
					radius=10
					side=1
				[/remove_shroud]
				{GENERIC_UNIT 4 "Dwarvish Loremaster"   56  4}                                       #######the throne room guards
				{GENERIC_UNIT 4 "Dwarvish Runemaster"   62  5}                                       #######the throne room guards
				[store_unit]
					[filter]
						id=$unit.id
					[/filter]
					variable=gomdrings_guard
					kill=no
				[/store_unit]
				{VARIABLE temp_x1                 57}
				{VARIABLE temp_x2                 59}
				{VARIABLE temp_y $gomdrings_guard.y}
				{VARIABLE_OP temp_y sub 2}
				[unstore_unit]
					variable=gomdrings_guard
					fire_event=yes
				[/unstore_unit]
				{MOVE_UNIT id=Alantor $temp_x1 $temp_y}
				{MOVE_UNIT id=Borudus $temp_x2 $temp_y}
				[message]
					speaker="Alantor"
					message= _ "Stop Human!"
				[/message]
				[message]
					speaker="Gomdring"
					message= _ "Who are you? Come closer!"
				[/message]
				{MOVE_UNIT id=Alantor  56  8}
				{MOVE_UNIT id=Borudus  60  8}
				{MOVE_UNIT id=$unit.id 58  7}
				{MOVE_UNIT id=$unit.id 58  6}
				[message]
					speaker=$unit.id
					message= _ "I am a soldier of Lord Antar.  My Lord wishes to speak with you."
				[/message]
				[message]
					speaker="Gomdring"
					message= _ "Then he should come to me."
				[/message]
				{OBJECTIVES_NEW (Now move Antar in the throneroom to meet Gomdring)}
				{VARIABLE_OP gomdring_found value yes}
				{CLEAR_VARIABLE gomdrings_guard}
				{CLEAR_VARIABLE temp_x1}
				{CLEAR_VARIABLE temp_x2}
				{CLEAR_VARIABLE temp_y}
			[/then]
		[/if]
	[/event]


		##################################
		#### when Antar meets Gomdring ###
		##################################

	[event]
		name=moveto
		[filter]
			id=Antar
			[filter_location]
				x,y=58,5
				radius=3
			[/filter_location]
		[/filter]
		[message]
			speaker="Alantor"
			message= _ "Stop Human!"
		[/message]
		{ASoR_REMOVE_SHROUD_SCROLLTO 58 5 7 1}
		[if]
			[variable]
				name=gomdring_found
				equals=no
			[/variable]
			[then]
				[message]
					speaker="Gomdring"
					message= _ "Who are you?"
				[/message]
			[/then]
			[else]
				[message]
					speaker="Gomdring"
					message= _ "Oh, you must be the Human leader who wants to talk with me?"
				[/message]
				[message]
					speaker="Antar"
					message= _ "Yes I am."
				[/message]
				[message]
					speaker="Gomdring"
					message= _ "Your men fight well!  *<i>for Humans!</i>*"
				[/message]
			[/else]
		[/if]
		[message]
			speaker="Antar"
			message= _ "I am Antar, son of Lord Rheor. I am a friend in need."
		[/message]
		[message]
			speaker="Gomdring"
			message= _ "You are welcome, Human. But we are a little busy at the moment. The Undead are attacking us."
		[/message]
		{MOVE_UNIT id="Antar" 58  7}
		[message]
			speaker="Antar"
			message= _ "Why?"
		[/message]
		[if]
			[variable]
				name=wizard_status
				numerical_equals=0
			[/variable]
			[then]
				[message]
					speaker="Gomdring"
					message= _ "They want to free one of their masters who we have in prison here.  They are too many, we can hardly resist them.  We might need help."
				[/message]
				[message]
					speaker="Antar"
					message= _ "A sorcerer?"
				[/message]
				[message]
					speaker="Gomdring"
					message= _ "Yes, we tried to get information from him.  But before we could question him, we were attacked."
				[/message]
			[/then]
		[/if]
		[if]
			[variable]
				name=wizard_status
				numerical_equals=1
			[/variable]
			[then]
				[message]
					speaker="Gomdring"
					message= _ "They have freed one of their masters who we had imprisoned here.  They were too many.  They freed him and now they want ho annihilate us. We might need help."
				[/message]
				[message]
					speaker="Antar"
					message= _ "A sorcerer?"
				[/message]
				[message]
					speaker="Gomdring"
					message= _ "Yes, we tried to get information from him. But before we he could question him, they attacked us and freed him."
				[/message]
			[/then]
		[/if]
		[if]
			[variable]
				name=wizard_status
				numerical_equals=2
			[/variable]
			[then]
				[message]
					speaker="Gomdring"
					message= _ "They have freed one of their masters who we  had imprisoned here.  They were too many.  They freed him and now they want ho annihilate us. We might need help."
				[/message]
				[message]
					speaker="Antar"
					message= _ "A sorcerer?"
				[/message]
				[message]
					speaker="Gomdring"
					message= _ "Yes, we tried to get information from him.  But before we he could question him, they attacked us and freed him. But he is dead now."
				[/message]
			[/then]
		[/if]
		[message]
			speaker="Antar"
			message= _ "Although we have come to ask for your help, we will help you."
		[/message]
		[message]
			speaker="Antar"
			message= _ "The evil will prevail if we do not stand together."
		[/message]
		{OBJECTIVES_NEW (Clear the mines. Defeat all enemies)}
		{VARIABLE_OP gomdring_found value yes}
		{VARIABLE_OP turns_to_trigger value 3}
		{VARIABLE turns 17}
		{VARIABLE_OP turns add $turn_number}
		[modify_turns]
			value=$turns
		[/modify_turns]
		[message]
			speaker=narrator
			message= _ "You have now 15 turns to clear the mines."
			image=wesnoth-icon.png
		[/message]
		[chat]
			speaker= _ "Gameplay"
			message= _ "You have now 15 turns to clear the mines."
		[/chat]
		{CLEAR_GUARDIAN (Brumdrus) }
		{CLEAR_GUARDIAN (Narfus)   }
		{CLEAR_GUARDIAN (Ferodur)  }
		{CLEAR_GUARDIAN (Beomir)   }
		{CLEAR_GUARDIAN (Andobrur) }
		{CLEAR_GUARDIAN (Aifried)  }
		{CLEAR_GUARDIAN (Alantor)  }
		{CLEAR_GUARDIAN (Angudus)  }
		{CLEAR_GUARDIAN (Balmor)   }
		{CLEAR_GUARDIAN (Borudus)  }

		### nested event for condition win
		[event]
			name=die
			first_time_only=no
			[if]
				[variable]
					name=wizard_status
					greater_than=0   ### wizzard is free or dead
				[/variable]
				[then]
					[if]
						[have_unit]
							side=7
							count=0
						[/have_unit]
						[have_unit]
							side=8
							count=0
						[/have_unit]
						[have_unit]
							side=9
							count=0
						[/have_unit]
						[not]
							[have_unit]
								id="Noach"
								side=9
							[/have_unit]
						[/not]
						[have_unit]
							side="10"
							count=0
						[/have_unit]
						[then]
							[message]
								speaker=second_unit
								message= _ "That was the last of the intruders!"
							[/message]
							[endlevel]
								result=victory
							[/endlevel]
						[/then]
					[/if]
				[/then]
				[else]
					[if]
						[have_unit]
							side=7
							count=0
						[/have_unit]
						[have_unit]
							side=8
							count=0
						[/have_unit]
						[have_unit]
							side=9
							count=1
						[/have_unit]
						[have_unit]
							side="10"
							count=0
						[/have_unit]
						[then]
							[kill]
								id="Noach"             ### needed to trigger 'enemies defeated'
								animate=no
							[/kill]
							{PLACE_IMAGE ("units/undead-necromancers/dark-sorcerer.png~RC(magenta>ASoR__Mediumorchid)")            46 12}
							[message]
								speaker=second_unit
								message= _ "That was the last of the intruders!"
							[/message]
							[endlevel]
								result=victory
							[/endlevel]
						[/then]
					[/if]
				[/else]
			[/if]
		[/event]
	[/event]

	[event]
		name=new turn
		first_time_only=no
		[set_variable]
			name=turns_to_trigger
			add=-1
		[/set_variable]
		[if]
			[variable]
				name=turns_to_trigger
				numerical_equals=0
			[/variable]
			[then]
				{CLEAR_VARIABLE turns_to_trigger}
				{VARIABLE_OP generator_on add 1}
				[disallow_recruit]
					side=2
					type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Ulfserker
				[/disallow_recruit]
				[disallow_recruit]
					side=3
					type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Ulfserker
				[/disallow_recruit]
				[disallow_recruit]
					side=4
					type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Ulfserker,Dwarvish Dragonguard,Dwarvish Runesmith,Dwarvish Stalwart
				[/disallow_recruit]
				[disallow_recruit]
					side=5
					type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Ulfserker
				[/disallow_recruit]
				[disallow_recruit]
					side=6
					type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Ulfserker
				[/disallow_recruit]
				[modify_side]
					side=4
					[ai]
						passive_leader=no
					[/ai]
				[/modify_side]
				[modify_unit]
					[filter]
						id=Gomdring
					[/filter]
					goto_x=61
					goto_y=27
				[/modify_unit]
#				{IF_HAVE_UNIT_GOTO_XY "Aigatsil"   54 23}
#				{IF_HAVE_UNIT_GOTO_XY "Nardris"    65 23}
#				{IF_HAVE_UNIT_GOTO_XY "Noringgurt" 65 23}
#				{IF_HAVE_UNIT_GOTO_XY "Ambergur"   54 21}
			[/then]
		[/if]
	[/event]


		############################################
		#### when someone finds the holy amulett ###
		############################################

	[event]
		name=open_entrance
		{ASoR_NARRATOR (A former hidden entrance becomes visible.)}
		[terrain]
			x,y=34,17
			terrain=Hh
		[/terrain]
		[terrain]
			x,y=38,15
			terrain=Ur^Dr
		[/terrain]
		{ASoR_REDRAW}
		[message]
			speaker=unit
			message= _ "Here is a half buried entrance!"
		[/message]
		[event]
			name=moveto
			[filter]
				side=1
				[filter_location]
					x=38,39,39
					y=15,14,15
					radius=1
				[/filter_location]
			[/filter]
			[message]
				speaker=unit
				message= _ "I am in a storage chamber!"
			[/message]
		[/event]
	[/event]


		############################################
		#### when Gomdring reaches the frontline ###
		############################################

	[event]
		name=moveto
		[filter]
			id=Gomdring
			[filter_location]
				x,y=54,22
				radius=3
			[/filter_location]
		[/filter]
		[message]
			speaker=Gomdring
			message= _ "Attack those Undead scum my Dwarvish brothers, let’s show the Humans how tough Dwarves can fight!"
		[/message]
	[/event]

	[event]
		name=attacker hits
		[filter]
			id=Gomdring
		[/filter]
		[message]
			speaker=Gomdring
			message= _ "Nobody annoys a Dwarf, take this!"
		[/message]
	[/event]


		########################################
		#### the evil prisoner may get freed ###
		########################################

	[event]
		name=attack
		first_time_only=yes
		[filter_second]
			type=Prisondoor
		[/filter_second]
		[remove_shroud]
			x,y=$x1,$y1
			radius=6
			side=1
		[/remove_shroud]
		[message]
			speaker="Noach"
			message= _ "The hordes of the Master came to free me."
		[/message]
	[/event]

	[event]
		name=die
		[filter]
			id="Prisondoor1"
		[/filter]
		[terrain]
			terrain=Ur
			x,y=47,15
		[/terrain]
		[remove_item]
			x,y=47,15
		[/remove_item]
		[kill]
			x,y=$x1,$y1
			animate=yes
		[/kill]
#		{MOVE_UNIT id=Noach 47 13}
		[message]
			speaker="Noach"
			message= _ "My revenge is near. Hahahaha."
		[/message]
	[/event]

	[event]
		name=die
		[filter]
			id="Prisondoor2"
		[/filter]
		[terrain]
			terrain=Ur
			x,y=48,13
		[/terrain]
		[terrain]
			terrain=Uu
			x,y=47,13
		[/terrain]
		[remove_item]
			x,y=48,13
		[/remove_item]
		[kill]
			x,y=$x1,$y1
			animate=yes
		[/kill]
		{MOVE_UNIT id=Noach 48 13}
		[message]
			speaker="Noach"
			message= _ "I am free now. Hahahahah! Now you will feel my revenge, Dwarvish scum."
		[/message]
		[store_unit]
			[filter]
				side=2,3,4,5,6
				[filter_location]
					x,y=47,15
					radius=4
				[/filter_location]
			[/filter]
			variable=warden
			kill=no
		[/store_unit]
		[unstore_unit]
			variable=warden
			fire_event=yes
		[/unstore_unit]
		[message]
			speaker=$warden.id
			message= _ "<b>The wizard is free!</b>"
		[/message]
		{CLEAR_VARIABLE warden}
		[modify_side]
			side=4
			{INCOME 13 17 19}
		[/modify_side]
		### activate the prisoner
		[modify_side]
			side=9
			controller=ai
		[/modify_side]
		### clear target prisondoor
		[store_unit]
			[filter]
				race=undead
			[/filter]
			variable=clear_target_prisondoor
			kill=no
		[/store_unit]
		[unstore_unit]
			variable=clear_target_prisondoor
			fire_event=yes
		[/unstore_unit]
		{FOREACH clear_target_prisondoor i}
			[modify_unit]
				[filter]
					id=$clear_target_prisondoor[$i].id
				[/filter]
				goto_x=0
				goto_y=0
			[/modify_unit]
		{NEXT i}
		{CLEAR_VARIABLE clear_target_prisondoor}
		### set variable wizzard alive
		{VARIABLE_OP wizard_status add 1}
		### set a destination for the sorcerer
		[modify_unit]
			[filter]
				id="Noach"
			[/filter]
			goto_x=48
			goto_y=19
		[/modify_unit]
		[allow_undo]
		[/allow_undo]
	[/event]

	[event]
		name=prerecruit
		[filter_second]
			id="Noach"
		[/filter_second]
		[message]
			speaker="Noach"
			message= _ "Here I can recall my Ghosts and Shadows, my Undead warriors. Now I will take my revenge. You will all die."
		[/message]
	[/event]


		###########################
		#### last breath events ###
		###########################

	[event]
		name=last breath                ###### set new target for dwarves when the eastern death knight dies
		first_time_only=no
		[filter]
			id="Lord Menachem"
		[/filter]
		[modify_side]
			side=2
			[ai]
				{ASoR_AI_GOAL__TARGET_SIDE__SIDES_VALUE 10 3}
			[/ai]
		[/modify_side]
		[disallow_recruit]
			side=2
			type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Ulfserker,Dwarvish Scout
		[/disallow_recruit]
	[/event]

	[event]
		name=last breath                ###### set new target for dwarves when the western death knight dies
		first_time_only=no
		[filter]
			id="Lord Baruch"
		[/filter]
		[modify_side]
			side=3
			[ai]
				{ASoR_AI_GOAL__TARGET_SIDE__SIDES_VALUE 10 3}
			[/ai]
		[/modify_side]
		[disallow_recruit]
			side=3
			type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Ulfserker,Dwarvish Scout
		[/disallow_recruit]
	[/event]

	[event]
		name=last breath
		first_time_only=no
		[filter]
			id="Ambergur"
		[/filter]
		{VIPDEAD}
		{IF_HELP_YES_THEN "Ambergur, a dwarvish sub leader is fallen."}
	[/event]

	[event]
		name=last breath
		first_time_only=no
		[filter]
			id="Noringgurt"
		[/filter]
		{VIPDEAD}
		{IF_HELP_YES_THEN "Noringgurt, a dwarvish sub leader is fallen."}
	[/event]

	[event]
		name=last breath                ### when Gomdring dies the mission is failed
		[filter]
			id="Gomdring"
		[/filter]
		{VIPDEAD}
		[message]
			speaker="Gomdring"
			message= _ "Death has found me!"
		[/message]
		[message]
			speaker="Antar"
			message= _ "Without Gomdrings support we are lost."
		[/message]
		{DEFEAT}
	[/event]

	[event]
		name=last breath                ### defender of the northern gate
		[filter]
			id="Aigatsil"
		[/filter]
		{VIPDEAD}
		[if]
			[variable]
				name=wizard_status
				numerical_not_equals=1
			[/variable]
			[then]
				[gold]
					side=5
					amount=40
				[/gold]
			[/then]
			[else]
				[gold]
					side=5
					amount=90
				[/gold]
			[/else]
		[/if]
		[if]
			[have_unit]
				id="Lord Menachem"
			[/have_unit]
			[then]
				[modify_side]
					side=7
					[ai]
						[leader_goal]
							x,y=20,8
						[/leader_goal]
					[/ai]
				[/modify_side]
			[/then]
		[/if]
		{IF_HELP_YES_THEN "Aigatsil, a dwarvish sub leader is fallen."}
	[/event]

	[event]
		name=last breath                ### defender of the southern gate
		[filter]
			id="Nardris"
		[/filter]
		{VIPDEAD}
		[if]
			[variable]
				name=wizard_status
				numerical_not_equals=1
			[/variable]
			[then]
				[gold]
					side=6
					amount=40
				[/gold]
			[/then]
			[else]
				[gold]
					side=6
					amount=90
				[/gold]
			[/else]
		[/if]
		[if]
			[have_unit]
				id="Lord Baruch"
			[/have_unit]
			[then]
				[modify_side]
					side=8
					[ai]
						[leader_goal]
							x,y=44,29
						[/leader_goal]
					[/ai]
				[/modify_side]
			[/then]
		[/if]
		{IF_HELP_YES_THEN "Nardris, a dwarvish sub leader is fallen."}
	[/event]

	[event]
		name=last breath                ### death of the prisoner
		[filter]
			id="Noach"
		[/filter]
		{VIPDEAD}
		{VARIABLE_OP wizard_status add 1}
	[/event]

	[event]
#		name=enemies defeated    ### triggers when all enemy canrecruit=yes are killed
		name=victory
		[message]
			speaker="Antar"
			message= _ "The battle is won!"
		[/message]
		[message]
			speaker="Gomdring"
			message= _ "Yes, but they will seek revenge for this defeat!"
		[/message]

		{MAKE_CANRECRUIT_NO   (Aigatsil)}
		{MAKE_CANRECRUIT_NO    (Nardris)}
		{MAKE_CANRECRUIT_NO   (Ambergur)}
		{MAKE_CANRECRUIT_NO (Noringgurt)}

		{MODIFY_UNIT (side=2)     side 2}            ### next scenario Gomdring is side 2 leader
		{MODIFY_UNIT (side=3)     side 2}            ### next scenario Gomdring is side 2 leader
		{MODIFY_UNIT (side=5)     side 2}            ### next scenario Gomdring is side 2 leader
		{MODIFY_UNIT (side=6)     side 2}            ### next scenario Gomdring is side 2 leader

		{FULL_HEAL side=2}                           ### every Dwarf should be healthy next battle

		{ASoR_DELAY 2000}

		[endlevel]
			result=victory
			bonus=yes
			{NEW_GOLD_CARRYOVER 40}
		[/endlevel]
	[/event]

	[event]
		name=victory
		{CLEAR_SCENARIO_VARIABLES}
	[/event]

	{~add-ons/Antar/utils/teg_force_ai_to_heal.cfg}
	{~add-ons/Antar/utils/utils.cfg}
	{~add-ons/Antar/utils/deaths.cfg}
[/scenario]

#undef INITIALIZE_SCENARIO_VARIABLES
#undef CLEAR_SCENARIO_VARIABLES
#undef STAY_INSIDE_THE_WALLS
#undef DWARV_BEHAVIOR
#undef VIPDEAD
#undef OBJECTIVES_NEW NEWOBJ
#undef CLEAR_GUARDIAN ID
#undef MAKE_CANRECRUIT_NO ID
#undef IF_HAVE_UNIT_GOTO_XY UNIT GOTO_X GOTO_Y
